#### step1简介

step1完成了一个简单的裸机上的程序，一个编译器和一个模拟器。这个裸机程序目前只能打印字符，它将是未来操作系统的雏形。编译器目前只能将3条汇编语言翻译成机器语言，它将是未来编译器的雏形。模拟器目前只能执行3条机器指令，主要用来测试指令集，这些指令将用来指导CPU的设计。step1全部代码加起来也只有区区两百行。

#### 操作系统

操作系统现在看来是没什么用的，只能打印一些字符到显示屏上。

目前只有1个外设显示控制器，端口号为1。向端口1写入的字符将会直接打印在屏幕上。

例如要打印字符'H'，使用如下指令即可

```
irmov 'H', %ra		//将字符H的编码传入寄存器ra
out %ra, 1			//将寄存器ra的值传入端口1
```

最后有一个halt指令，用于CPU正常关机。

#### 编译器

编译器完成的工作是把汇编语言直译成机器语言。

如下为汇编语言和机器语言的对照表

| 汇编语言  | irmov V, %ra  | out %ra, 1    | halt |
| ----- | ------------- | ------------- | ---- |
| 机器语言  | 0x01 + V + ra | 0x02 + ra + 1 | 0x00 |
| 占用字节数 | 3             | 3             | 1    |

汇编器使用了flex来识别汇编语言中的元素，元素对应的规则就是把元素编号直接写入目标文件中

例如单个字符是这么识别的：`LETTER \'[^ /t/r/n]\'`。LETTER是单个字符的标记，\'代表单引号'，`[^ /t/r/n]`代表除空格、制表符、回车和换行之外的其它符号。

单个字符对应的规则是：`{LETTER} add_letter(yytext); `yytext代表当前分析到的字符串，add_letter的作用是把当前字符串代表的字符写入目标文件中。写入文件最终是通过fwrite函数实现的。

#### 模拟器

模拟器完成的工作是执行机器语言。

模拟器把硬盘中的内容全部装载到内存中，然后从pc=0处开始执行，直到遇到halt指令。

irmov是给寄存器赋值，实际对应的语句大致是这样的：`ra = mem[pc]`

out是把字符打印到屏幕上，实际对应的语句是：`printf("%c", ra);`

halt是退出系统，实际对应的语句是`return`。

